{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "13c6f457_9c74b17f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1541
      },
      "writtenOn": "2023-01-03T18:30:07Z",
      "side": 1,
      "message": "Why wouldn\u0027t we want to reload the pack if any PackExt file changed?",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e9fc1bee_630dbc2f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 290522
      },
      "writtenOn": "2023-01-03T18:49:44Z",
      "side": 1,
      "message": "We already have code which is reloading pack file or index file was changed we are missing only bitmap",
      "parentUuid": "13c6f457_9c74b17f",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4f14c72b_78436006",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1541
      },
      "writtenOn": "2023-01-03T19:33:00Z",
      "side": 1,
      "message": "I don\u0027t see any code for when the index file changes, where is that?\n\nAnd it\u0027s not there yet, but reverse index file support has a change up for review: 197593: Pack: open reverse index from file if present | https://git.eclipse.org/r/c/jgit/jgit/+/197593\n\nI would think we\u0027d want something like newPack.isModified(Pack old) that can do the appropriate checks for anything important to the Pack.",
      "parentUuid": "e9fc1bee_630dbc2f",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b8c018e2_810d1f5d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 290522
      },
      "writtenOn": "2023-01-03T22:20:46Z",
      "side": 1,
      "message": "\u003e I don\u0027t see any code for when the index file changes, where is that?\n\nIn this line we have check if pack file has an index file, if not we skip that pack file:\nhttps://git.eclipse.org/r/c/jgit/jgit/+/197868/4/org.eclipse.jgit/src/org/eclipse/jgit/internal/storage/file/PackDirectory.java#429\n\n\u003e I would think we\u0027d want something like newPack.isModified(Pack old) that can do the appropriate checks for anything important to the Pack.\n\nThat\u0027s actually a good idea if we want to reload pack file when bitmap file has changed. But as Luca mentioned in his comment we want to reload just the bitmap index when the bitmap file was modified",
      "parentUuid": "4f14c72b_78436006",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f73a0d75_bf084792",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1541
      },
      "writtenOn": "2023-01-03T22:34:05Z",
      "side": 1,
      "message": "\u003e \u003e I don\u0027t see any code for when the index file changes, where is that?\n\u003e \n\u003e In this line we have check if pack file has an index file, if not we skip that pack file:\n\nBut that\u0027s different than checking if the index has changed. I don\u0027t see a check for a changed index file.\n\n\u003e \n\u003e \u003e I would think we\u0027d want something like newPack.isModified(Pack old) that can do the appropriate checks for anything important to the Pack.\n\u003e \n\u003e That\u0027s actually a good idea if we want to reload pack file when bitmap file has changed. But as Luca mentioned in his comment we want to reload just the bitmap index when the bitmap file was modified\n\nI think it\u0027s a good layering approach no matter what you want to reload. Pack should decide what to reload, not something higher up.",
      "parentUuid": "b8c018e2_810d1f5d",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "315e9203_965e2025",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 14,
      "author": {
        "id": 1541
      },
      "writtenOn": "2023-01-03T18:30:07Z",
      "side": 1,
      "message": "But when is that actually a problem? scanPackImpl doesn\u0027t try to read the bitmap file and it always creates a Pack with the potential name of the bitmapIdxFile passed in. That file isn\u0027t read until someone calls getBitmapIndex() sometime later though.",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c9774fed_51a997cb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 14,
      "author": {
        "id": 290522
      },
      "writtenOn": "2023-01-03T18:49:44Z",
      "side": 1,
      "message": "The problem is here https://git.eclipse.org/r/c/jgit/jgit/+/197868/3/org.eclipse.jgit/src/org/eclipse/jgit/internal/storage/file/PackDirectory.java#447\n\nWhen we create a Pack object and bitmap file is missing we will pass null. This means that we never gonna try to load bitmap for that pack file.\n\nIf we move that check to the getBitmapIndex this means that for pack files without bitmap we would have to always check if the file is there. I believe that\u0027s why we have scanPackImpl to make sure that we check/reload pack files only when they are modified. If trustFolderStats is set to true this will happen only when packs directory modified time is updated.",
      "parentUuid": "315e9203_965e2025",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "19a9eff0_c0dc5f60",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 14,
      "author": {
        "id": 1541
      },
      "writtenOn": "2023-01-03T19:33:00Z",
      "side": 1,
      "message": "\u003e The problem is here https://git.eclipse.org/r/c/jgit/jgit/+/197868/3/org.eclipse.jgit/src/org/eclipse/jgit/internal/storage/file/PackDirectory.java#447\n\u003e \n\u003e When we create a Pack object and bitmap file is missing we will pass null. This means that we never gonna try to load bitmap for that pack file.\n\nYeah, I misread the code when I said \"it always creates a Pack with the potential name of the bitmapIdxFile passed in\". It doesn\u0027t do that, it passes a file only if the directory listing had one.\n\nSo when we first did the directory listing the bitmap file wasn\u0027t present, but the index and pack were (and so it was a valid pack). And now we\u0027ve called scanPacksImpl() again sometime later and the bitmap index is present, but the packfile hasn\u0027t changed. Is that correct?\n\nIf yes, I think my suggestion in the comment thread above for a Pack.isModified() method would be an appropriate replacement for the oldPack.getFileSnapshot().isModified(packFile) check.\n\nYou could also consider a separate follow-up change (on master) to add a Pack constructor that takes the oldPack if there\u0027s work that\u0027s expensive that we can *safely* skip if only a subset of files were modified. That seems really hard to get right and maintain correctly though, so I would skip it unless you find some use case where it\u0027s very important to have it.\n\n\u003e \n\u003e If we move that check to the getBitmapIndex this means that for pack files without bitmap we would have to always check if the file is there. I believe that\u0027s why we have scanPackImpl to make sure that we check/reload pack files only when they are modified. If trustFolderStats is set to true this will happen only when packs directory modified time is updated.\n\nAck.",
      "parentUuid": "c9774fed_51a997cb",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d70a58c4_75e8f20d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 14,
      "author": {
        "id": 290522
      },
      "writtenOn": "2023-01-03T22:32:38Z",
      "side": 1,
      "message": "\u003e So when we first did the directory listing the bitmap file wasn\u0027t present, but the index and pack were (and so it was a valid pack). And now we\u0027ve called scanPacksImpl() again sometime later and the bitmap index is present, but the packfile hasn\u0027t changed. Is that correct?\n\n\u003eIf yes, I think my suggestion in the comment thread above for a Pack.isModified() method would be an appropriate replacement for the oldPack.getFileSnapshot().isModified(packFile) check\n\nThat\u0027s correct. And as I mentioned in my comment above having Pack.isModified() would be the right direction if we  want to reload the full pack object when only one of the files have changed. But as Luca mentioned reloading pack file can be a very expensive operation so we prefer to reload just the bitmap index.\n\nWith that assumption it totally makes sense to have a follow-up change on master to add Pack constructor that copy unmodified parts of the old pack. I\u0027m happy to work on that change",
      "parentUuid": "19a9eff0_c0dc5f60",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "83bcd27e_258bf9ca",
        "filename": "org.eclipse.jgit/src/org/eclipse/jgit/internal/storage/file/Pack.java",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 1541
      },
      "writtenOn": "2023-01-03T18:30:07Z",
      "side": 1,
      "message": "Shouldn\u0027t this only happen in getBitmapIndex() when we actually read the bitmapIdx?",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ec6841d8_5fc27e39",
        "filename": "org.eclipse.jgit/src/org/eclipse/jgit/internal/storage/file/Pack.java",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 290522
      },
      "writtenOn": "2023-01-03T18:49:44Z",
      "side": 1,
      "message": "I wanted to be consistent with a pack file which we are storing in L140",
      "parentUuid": "83bcd27e_258bf9ca",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0f6c1cd3_4ff88fc3",
        "filename": "org.eclipse.jgit/src/org/eclipse/jgit/internal/storage/file/Pack.java",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 1541
      },
      "writtenOn": "2023-01-03T19:33:00Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "ec6841d8_5fc27e39",
      "revId": "02cdf34c9f55cef76cbde2a5c34e493e5fa4a3b7",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31"
    }
  ]
}