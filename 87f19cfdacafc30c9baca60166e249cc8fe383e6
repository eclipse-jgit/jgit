{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "fb07b69a_673762ad",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1016501
      },
      "writtenOn": "2026-02-09T09:39:54Z",
      "side": 0,
      "message": "Would be nice, if the wrapper wouldn\u0027t be needed.\nAt least we could maybe rename it to `standalone-build`.\nOr we just document that users should navigate to the `tools/standalone` dir and use bazel from there.",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "788db167_477a4e93",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000671
      },
      "writtenOn": "2026-02-09T09:47:58Z",
      "side": 0,
      "message": "could this decision (whether to run bazel with the standalone root module or not) be configured in `.bazelrc` in jgit and gerrit respectively instead of using this wrapper ?",
      "parentUuid": "fb07b69a_673762ad",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "384f5d11_833ed38d",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000177
      },
      "writtenOn": "2026-02-09T09:57:41Z",
      "side": 0,
      "message": "\u003e Would be nice, if the wrapper wouldn\u0027t be needed.\n\n+1\n\n\u003e could this decision (whether to run bazel with the standalone root module or not) be configured in .bazelrc in jgit and gerrit respectively instead of using this wrapper ?\n\nUnfortunately, I’m not aware of another way to make this work (or at least I haven’t found one so far).\n\nI completely agree with you that avoiding the wrapper would be preferable, but I haven’t found an easier alternative. As discussed in another Gerrit change, there are still alternative approaches involving merging the two maven.install definitions in Gerrit and JGit, which I would like to avoid as well.\n\nThis split — and the resulting need for the wrapper — is the reason why I raised this question in the Bazel Slack channel: [1], quoting:\n\n\"\"\"\n[...]\nIn JGit we implemented (1) by splitting the Bazel setup into:\na library module that relies on the root module for dependency resolution, anda standalone wrapper module used to build and test JGit in isolation\n\nTo support standalone builds, we currently use a small bazelw wrapper that runs Bazel from tools/standalone (making that directory the root module):\n\n#!/usr/bin/env bash\nset -euo pipefail\nROOT_DIR\u003d\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\nSTANDALONE_DIR\u003d\"${ROOT_DIR}/tools/standalone\"\ncd \"${STANDALONE_DIR}\"\nexec bazelisk \"$@\"\n\nThis works, but it feels a bit convoluted and adds friction to the developer workflow, so we’d very much like to avoid such wrappers if there’s a cleaner pattern.\n\nWe haven’t tried approach (2) yet and would love to hear opinions from folks who’ve dealt with similar setups:\n\nIs approach (1) the recommended way to model “library modules” with bzlmod + rules_jvm_external?If approach (2) is viable, what’s the best practice to ensure the root module’s versions always win, to avoid classpath duplication, and to ensure that the library (JGit) is built against exactly the same dependency versions selected by the root module (Gerrit), so that runtime errors are avoided?\n[...]\n\"\"\"\n\n[1]: https://bazelbuild.slack.com/archives/CDCE4DFAP/p1770243177511579",
      "parentUuid": "788db167_477a4e93",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "10d359af_36b0aa37",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000671
      },
      "writtenOn": "2026-02-09T10:04:48Z",
      "side": 0,
      "message": "can you invite me to the bazel slack channel ?",
      "parentUuid": "384f5d11_833ed38d",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4a51e036_48e73be3",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000177
      },
      "writtenOn": "2026-02-09T11:23:21Z",
      "side": 0,
      "message": "Done.",
      "parentUuid": "10d359af_36b0aa37",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a9e12e05_8788889d",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000177
      },
      "writtenOn": "2026-02-11T06:07:06Z",
      "side": 0,
      "message": "While the current split (library module + standalone wrapper) avoids duplicate dependency universes, I wonder whether we could simplify this further.\n\nWould a variant of approach (2) be viable?\n\nConcretely:\n\n* Keep maven.install() in both JGit and Gerrit, contributing to the same `external_deps` repository.\n* In Gerrit (as root module), enforce deterministic resolution via:\n*** `conflict_resolution_strategy \u003d \"pinned\"`\n*** `force_version \u003d True`\n* Potentially use `known_contributing_module` in `rules_jvm_external` to explicitly model JGit and Gerrit as a contributing modules.\n\nIf resolution is strictly root-preferential under `pinned` mode, this could allow us to:\n* avoid the standalone wrapper, and\n* still guarantee a single effective classpath at compile and runtime.\n\nThe open question is whether this pattern is officially supported and robust enough to prevent duplicate artifacts and compile-time vs runtime mismatches, or whether the current split-module approach remains the safer long-term design.",
      "parentUuid": "4a51e036_48e73be3",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "75fcc4e4_f0b6ed4d",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1016501
      },
      "writtenOn": "2026-02-11T07:35:31Z",
      "side": 0,
      "message": "AFAIK `force_version` is not an option of `from_toml` or `install`. We would have to explicitly do that for every affected dependency using `amend_artifact`. This would mean some effort and be error_prone, i.e. if there is a new dep in jgit, it might be missed to be overridden in Gerrit. There should then at least be a test to guard from this.\nAlternatively, we could of course contribute that option to maven_install as well.",
      "parentUuid": "a9e12e05_8788889d",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d741d9ff_5d294d6e",
        "filename": "bazelw",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000177
      },
      "writtenOn": "2026-02-11T09:52:42Z",
      "side": 0,
      "message": "The alternative unfortunately does not work in practice.\n\nI tried keeping maven.install(name \u003d \"external_deps\") in both JGit and Gerrit and relying on:\n\n- version_conflict_policy \u003d \"pinned\"\n- force_version \u003d True\n- known_contributing_modules\n\nto make the root module (Gerrit) authoritative.\n\nHowever, when both modules contribute the same coordinate with different\nversions (e.g. args4j:2.33 in Gerrit vs 2.37 in JGit), the resolved\nartifact remains at 2.37 (the version contributed by JGit), even with\nforce_version \u003d True.\n\nIn other words, force_version does not override explicit cross-module\ncontributions when both modules contribute to the same maven.install\nrepository under bzlmod.\n\nA minimal reproduction is documented here [1].\n\nThis confirms that the root-preferential resolution pattern we were\nconsidering is not robust enough to guarantee a single authoritative\nclasspath when both modules contribute dependencies.\n\nGiven this behavior, the current split (library module without\nmaven.install() + standalone wrapper module) remains the safer and\nmore deterministic design.\n\nShould we continue with this separation for now and revisit alternative\napproaches once we have a robust and officially supported way to make\nroot-preferential resolution reliable across modules?\n\n[1]: https://gerrit-review.googlesource.com/c/gerrit/+/551102",
      "parentUuid": "75fcc4e4_f0b6ed4d",
      "revId": "87f19cfdacafc30c9baca60166e249cc8fe383e6",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}